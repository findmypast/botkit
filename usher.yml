version: '2'
vars:
  registry: docker-registry.dun.fh
  service_image_name: botkit
  token:
  service_folder: .

  docker_environment: &DOCKER_ENV
    - DOCKER_TLS_VERIFY=1
    - DOCKER_HOST=tcp://<%=service_node%>.dun.fh:2376
    - &IMAGE IMAGE=<%=registry%>/findmypast/<%=service_image_name%>:<%=version%>
    - TOKEN=<%=token%>

include:
  - from: git+ssh://git@github.com:findmypast/usher_shared_tasks.git
    name: shared_tasks as global
    import:
      - domesday
      - docker

tasks:
  build:
    description: Build Botkit stress test image for the repository
    do: global.docker.create_image
    service_name: <%=service_image_name%>

  push:
    description: Push Botkit stress tests image to the repository
    do: global.docker.push_image
    service_name: <%=service_image_name%>

  pull:
    description: Pull Botkit stress tests image from the repository
    do: global.docker.pull_image
    service_name: <%=service_image_name%>

  test:
    description: Run Botkit unit tests
    do: sequence
    actions:
      - do: read_key_auth
        path: test/token
        options:
          register: token
      - do: shell
        command: docker run --name <%=service_image_name%>-test-runner --rm <%=registry%>/findmypast/<%=service_image_name%>:<%=version%> npm run test

  publish:
    description: Publish Botkit to internal NPM
    do: global.docker.compose_run
    service_folder: .
    compose_filename: docker-compose-publish.yml
    service_name: publish
    env:
      - IMAGE=<%=registry%>/findmypast/<%=service_image_name%>:<%=version%>

  read_key_auth:
    do: global.domesday.read_key_value_auth
    description: Read Raiser secrets from the vault
    key: secret/<%=service_image_name%>/<%=path%>
    vault_username: <%=tc_username%>
    vault_password: <%=tc_password%>
